events {}
http {
    client_max_body_size 500M; 

    upstream app_backend {
        server app:8080;
    }

    upstream app_frontend {
        server frontend:3000;
    }

    # upstream github_integration_backend {
    #     server github-integration:8000;
    # }

    server {
        listen 80;

	        # ----------------------------
	        # OAuth callback pages (frontend)
	        # ----------------------------
	        # Google and GitHub OAuth providers redirect the browser back to
	        # /auth/{provider}/callback. These routes are implemented in the
	        # Next.js frontend app (app/auth/... in the frontend), not in the
	        # Go backend. We therefore special-case them here so they go to the
	        # frontend instead of the backend.
	        location = /auth/google/callback {
	            proxy_pass http://app_frontend;
	            proxy_set_header Host $host;
	            proxy_set_header X-Real-IP $remote_addr;
	        }

	        location = /auth/github/callback {
	            proxy_pass http://app_frontend;
	            proxy_set_header Host $host;
	            proxy_set_header X-Real-IP $remote_addr;
	        }

	        # --------------------
	        # Backend API routes
	        # --------------------
	        # Frontend is served at "/" on port 80, but API_BASE_URL still
	        # points to http://localhost:80. The Go API runs under /api/v1 and
	        # /auth, while Next.js API routes live under /api/...
	        #
	        # To avoid breaking Next.js API routes like /api/auth/google/callback,
	        # we ONLY send /api/v1/... to the backend. All other /api/* paths fall
	        # through to the default frontend location.
	        location /api/v1/ {
	            proxy_pass http://app_backend;
	            proxy_set_header Host $host;
	            proxy_set_header X-Real-IP $remote_addr;
	        }

        location /auth/ {
            proxy_pass http://app_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /doc.json {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
                add_header 'Access-Control-Allow-Headers' '*';
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Length' 0;
                add_header 'Content-Type' 'text/plain charset=UTF-8';
                return 204;
            }

            proxy_pass http://app_backend/docs/doc.json;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            # Add CORS headers to actual GET response too
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
            add_header 'Access-Control-Allow-Headers' '*';
        }

        # --------------------
        # Frontend routes
        # --------------------
        # Default route: serve frontend app from "frontend:3000"
        location / {
            proxy_pass http://app_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Optional /app prefix (kept for backward compatibility)
        location /app/ {
            rewrite ^/app(/.*)$ $1 break;
            proxy_pass http://app_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Handle exact /app (redirect to /app/ for consistency)
        location = /app {
            return 301 /app/;
        }

        # Support next.js dev environment assets
        location /_next/ {
            proxy_pass http://app_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # # GitHub webhooks still go to dedicated integration backend
        # location /api/webhooks/github {
        #     # Proxy to /v1/webhook on the github_integration_backend
        #     rewrite ^/api/webhooks/github$ /api/v1/webhook break;
        #     rewrite ^/api/webhooks/github/(.*)$ /api/v1/webhook/$1 break;
        #     proxy_pass http://github_integration_backend;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        # }
    }
}