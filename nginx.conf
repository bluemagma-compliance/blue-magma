worker_processes auto;

events {}

http {
    # -------- Core hardening / sane defaults --------
    server_tokens off;

    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Prevent slowloris / hung connections
    client_header_timeout 10s;
    client_body_timeout   20s;
    send_timeout          30s;
    keepalive_timeout     65s;

    # Your original global limit (kept)
    client_max_body_size 500M;

    # Rate limit zones (per IP)
    limit_req_zone $binary_remote_addr zone=contact_per_ip:10m rate=1r/s;
    limit_req_zone $binary_remote_addr zone=api_per_ip:10m     rate=20r/s;

    # Connection limit zone (per IP)
    limit_conn_zone $binary_remote_addr zone=conn_per_ip:10m;

    # Websocket upgrade helper
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Preserve original client scheme (https/http) when behind proxies
    # Prefer any incoming X-Forwarded-Proto header (from Cloudflare/ALB),
    # but fall back to the local connection scheme if it is missing.
    map $http_x_forwarded_proto $real_proto {
        default $http_x_forwarded_proto;
        ''      $scheme;
    }

    upstream app_backend {
        server app:8080;
        keepalive 32;
    }

    upstream app_frontend {
        server frontend:3000;
        keepalive 32;
    }

    upstream landing_site {
        server landing-website:3000;
        keepalive 16;
    }

    upstream graphlang_agent {
        server graphlang-agent:8001;
        keepalive 16;
    }

    # -------- Catch-all for unknown Host headers --------
    server {
        listen 80 default_server;
        server_name _;
        return 444;
    }

    # ----- Main marketing / landing site -----
    server {
        listen 80;
        server_name trybluemagma.com www.trybluemagma.com;

        # Marketing site shouldn't accept huge bodies
        client_max_body_size 2m;

        # Basic security headers (low-risk, generally non-breaking)
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

        # Per-IP connection cap
        limit_conn conn_per_ip 20;

        # ✅ Allow ONLY the contact endpoint to accept POST
        location = /api/contact {
            limit_except POST OPTIONS { deny all; }

            # Rate-limit this endpoint harder
            limit_req zone=contact_per_ip burst=5 nodelay;

            # If you need CORS for the contact form, keep OPTIONS enabled.
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "https://trybluemagma.com" always;
                add_header Access-Control-Allow-Methods "POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
                add_header Access-Control-Max-Age 86400 always;
                return 204;
            }

            proxy_pass http://landing_site;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $real_proto;

            proxy_connect_timeout 5s;
            proxy_send_timeout    30s;
            proxy_read_timeout    30s;
        }

        # Optional: if you don't have any other /api/* on the landing site
        location ^~ /api/ {
            return 404;
        }

        # ✅ Everything else should be read-only
        location / {
            limit_except GET HEAD { deny all; }

            proxy_pass http://landing_site;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $real_proto;

            proxy_connect_timeout 5s;
            proxy_send_timeout    30s;
            proxy_read_timeout    30s;
        }

        location /_next/ {
            limit_except GET HEAD { deny all; }

            proxy_pass http://landing_site;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $real_proto;

            proxy_connect_timeout 5s;
            proxy_send_timeout    30s;
            proxy_read_timeout    30s;
        }
    }

    # ----- App domain: frontend + backend API -----
    server {
        listen 80;
        server_name app.trybluemagma.com;

        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

        limit_conn conn_per_ip 40;

        # App frontend at root for app.trybluemagma.com
        location / {
            proxy_pass http://app_frontend;
            proxy_http_version 1.1;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $real_proto;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header Host              $host;

            proxy_connect_timeout 5s;
            proxy_send_timeout    60s;
            proxy_read_timeout    60s;
        }

        # Backend API route: only /api/v1/* goes to backend
        # Next.js API routes (e.g. /api/auth/*) stay on the frontend
        location /api/v1/ {
            # Only allow common API methods
            limit_except GET POST PUT PATCH DELETE OPTIONS { deny all; }

            # API rate limiting (so one IP can’t hammer it indefinitely)
            limit_req zone=api_per_ip burst=100 nodelay;

            # Preflight response (kept permissive like your original)
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' '*' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }

            proxy_pass http://app_backend;
            proxy_http_version 1.1;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $real_proto;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header Host              $host;

            add_header 'Access-Control-Allow-Origin' '*' always;

            proxy_connect_timeout 5s;
            proxy_send_timeout    300s;
            proxy_read_timeout    300s;
        }

        # GraphLang Agent WebSocket (proxied for secure wss://)
        location /ws {
            # Light limiting to reduce WS-flooding (adjust if needed)
            limit_req zone=api_per_ip burst=50 nodelay;

            proxy_pass http://graphlang_agent;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $real_proto;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header Host              $host;

            proxy_read_timeout 86400;
            proxy_send_timeout 86400;
            proxy_buffering off;
        }

        # OpenAPI doc endpoint (only on app.trybluemagma.com)
        location = /doc.json {
            limit_except GET OPTIONS { deny all; }

            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' '*' always;
                add_header 'Access-Control-Max-Age' 1728000 always;
                add_header 'Content-Length' 0 always;
                add_header 'Content-Type' 'text/plain; charset=UTF-8' always;
                return 204;
            }

            proxy_pass http://app_backend/docs/doc.json;
            proxy_http_version 1.1;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $real_proto;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header Host              $host;

            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' '*' always;

            proxy_connect_timeout 5s;
            proxy_send_timeout    60s;
            proxy_read_timeout    60s;
        }
    }
}
